---
title: Shapes, etc.

stack:
  inputs: any
  outputs:
    - name: out
      desc: 
  desc: Combines input tensors
  class: StackInstruction
  custom_op: True
unstack:
  inputs:
    - name: in
      desc: 
  outputs: any
  desc: 
  class: UnstackInstruction
  custom_op: True
batch_cat:
  inputs: any
  outputs:
    - name: out
      desc:
    - name: counts
      desc:
  desc:
  class: BatchCatInstruction
  custom_op: True
batch_split:
  inputs:
    - name: in
      desc:
    - name: counts
      desc:
  outputs: any
  desc:
  class: BatchSplitInstruction
  custom_op: True

---
title: Math

add:
  inputs:
    - name: in1
      type: [float, ...]
      desc: first input to addition
    - name: in2
      type: [float, ...]
      desc: second input to addition
  outputs:
    - name: out
      type: [float, ...]
      desc: sum of the two inputs
  desc: Computes the sum of the two inputs.
  dims: 0

sub:
  inputs:
    - name: in1
      type: [float, ...]
      desc: first input to subtraction
    - name: in2
      type: [float, ...]
      desc: second input to subtraction
  outputs:
    - name: out
      type: [float, ...]
      desc: difference of the two inputs
  desc: Computes the difference of the two inputs.
  dims: 0

mul:
  inputs:
    - name: in1
      type: [float]
      desc: first input to multiplication
    - name: in2
      type: [float]
      desc: second input to multiplication
  outputs:
    - name: out
      type: [float]
      desc: product of the two inputs
  desc: Computes the product of the two inputs.

product:
  inputs:
    - name: in
      type: [float, n]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

clip_min:
  inputs:
    - name: x
      type: [float]
      desc:
    - name: min
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

sqrt:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

square:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

pow:
  inputs:
    - name: in1
      type: [float]
      desc:
    - name: in2
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

uniform_phi:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

uniform_phi_inverse:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

uniform_costheta:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:

uniform_costheta_inverse:
  inputs:
    - name: in
      type: [float]
      desc:
  outputs:
    - name: out
      type: [float]
      desc:


---
title: Kinematics

rotate_zy:
  inputs:
    - name: p
      type: [float, 4]
      desc:
    - name: phi
      type: [float]
      desc:
    - name: cos_theta
      type: [float]
      desc:
  outputs:
    - name: q
      type: [float, 4]
      desc:

rotate_zy_inverse:
  inputs:
    - name: p
      type: [float, 4]
      desc:
    - name: phi
      type: [float]
      desc:
    - name: cos_theta
      type: [float]
      desc:
  outputs:
    - name: q
      type: [float, 4]
      desc:

boost:
  inputs:
    - name: p1
      type: [float, 4]
      desc:
    - name: p2
      type: [float, 4]
      desc:
  outputs:
    - name: p_out
      type: [float, 4]
      desc:

boost_inverse:
  inputs:
    - name: p1
      type: [float, 4]
      desc:
    - name: p2
      type: [float, 4]
      desc:
  outputs:
    - name: p_out
      type: [float, 4]
      desc:

boost_beam:
  inputs:
    - name: p1
      type: [float, n, 4]
      desc:
    - name: rap
      type: [float]
      desc:
  outputs:
    - name: p_out
      type: [float, n, 4]
      desc:

boost_beam_inverse:
  inputs:
    - name: p1
      type: [float, n, 4]
      desc:
    - name: rap
      type: [float]
      desc:
  outputs:
    - name: p_out
      type: [float, n, 4]
      desc:

com_momentum:
  inputs:
    - name: sqrt_s
      type: [float]
      desc:
  outputs:
    - name: p
      type: [float, 4]
      desc:

com_p_in:
  inputs:
    - name: e_cm
      type: [float]
      desc:
  outputs:
    - name: p1
      type: [float, 4]
      desc:
    - name: p2
      type: [float, 4]
      desc:

com_angles:
  inputs:
    - name: p
      type: [float, 4]
      desc:
  outputs:
    - name: phi
      type: [float]
      desc:
    - name: cos_theta
      type: [float]
      desc:

s:
  inputs:
    - name: p
      type: [float, 4]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:

sqrt_s:
  inputs:
    - name: p
      type: [float, 4]
      desc:
  outputs:
    - name: sqrt_s
      type: [float]
      desc:

s_and_sqrt_s:
  inputs:
    - name: p
      type: [float, 4]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:
    - name: sqrt_s
      type: [float]
      desc:

r_to_x1x2:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: s_hat
      type: [float]
      desc:
    - name: s_lab
      type: [float]
      desc:
  outputs:
    - name: x1
      type: [float]
      desc:
    - name: x2
      type: [float]
      desc:
    - name: det
      type: [float]
      desc:

x1x2_to_r:
  inputs:
    - name: x1
      type: [float]
      desc:
    - name: x2
      type: [float]
      desc:
    - name: s_lab
      type: [float]
      desc:
  outputs:
    - name: r
      type: [float]
      desc:
    - name: det
      type: [float]
      desc:

rapidity:
  inputs:
    - name: x1
      type: [float]
      desc:
    - name: x2
      type: [float]
      desc:
  outputs:
    - name: rap
      type: [float]
      desc:

---
title: Two-body decays and scattering

decay_momentum:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: sqrt_s
      type: [float]
      desc:
    - name: m1
      type: [float]
      desc:
    - name: m2
      type: [float]
      desc:
  outputs:
    - name: p
      type: [float, 4]
      desc:
    - name: gs
      type: [float]
      desc:

invt_min_max:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: s_in1
      type: [float]
      desc:
    - name: s_in2
      type: [float]
      desc:
    - name: m1
      type: [float]
      desc:
    - name: m2
      type: [float]
      desc:
  outputs:
    - name: t_min
      type: [float]
      desc:
    - name: t_max
      type: [float]
      desc:

invt_to_costheta:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: s_in1
      type: [float]
      desc:
    - name: s_in2
      type: [float]
      desc:
    - name: m1
      type: [float]
      desc:
    - name: m2
      type: [float]
      desc:
    - name: t
      type: [float]
      desc:
  outputs:
    - name: cos_theta
      type: [float]
      desc:

costheta_to_invt:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: s_in1
      type: [float]
      desc:
    - name: s_in2
      type: [float]
      desc:
    - name: m1
      type: [float]
      desc:
    - name: m2
      type: [float]
      desc:
    - name: cos_theta
      type: [float]
      desc:
  outputs:
    - name: t
      type: [float]
      desc:

        #two_particle_density:
        #  inputs:
        #    - name: s
        #      type: [float]
        #      desc:
        #    - name: m1
        #      type: [float]
        #      desc:
        #    - name: m2
        #      type: [float]
        #      desc:
        #  outputs:
        #    - name: gs
        #      type: [float]
        #      desc:

two_particle_density_inverse:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: m1
      type: [float]
      desc:
    - name: m2
      type: [float]
      desc:
  outputs:
    - name: gs
      type: [float]
      desc:

tinv_two_particle_density:
  inputs:
    - name: det_t
      type: [float]
      desc:
    - name: s
      type: [float]
      desc:
    - name: s_in1
      type: [float]
      desc:
    - name: s_in2
      type: [float]
      desc:
  outputs:
    - name: det
      type: [float]
      desc:

tinv_two_particle_density_inverse:
  inputs:
    - name: det_t
      type: [float]
      desc:
    - name: s
      type: [float]
      desc:
    - name: s_in1
      type: [float]
      desc:
    - name: s_in2
      type: [float]
      desc:
  outputs:
    - name: det
      type: [float]
      desc:

---
title: Invariants

uniform_invariant:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

uniform_invariant_inverse:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: r
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

breit_wigner_invariant:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: width
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

breit_wigner_invariant_inverse:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: width
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: r
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

stable_invariant:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

stable_invariant_inverse:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: r
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

stable_invariant_nu:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: nu
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: s
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

stable_invariant_nu_inverse:
  inputs:
    - name: s
      type: [float]
      desc:
    - name: mass
      type: [float]
      desc:
    - name: nu
      type: [float]
      desc:
    - name: s_min
      type: [float]
      desc:
    - name: s_max
      type: [float]
      desc:
  outputs:
    - name: r
      type: [float]
      desc:
    - name: gs
      type: [float]
      desc:

---
title: Fast RAMBO on diet

fast_rambo_r_to_u:
  inputs:
    - name: r
      type: [float, n]
      desc:
  outputs:
    - name: u
      type: [float, n]
      desc:
    - name: det
      type: [float]
      desc:

rambo_four_vectors_massless:
  inputs:
    - name: u
      type: [float, n]
      desc:
    - name: e_cm
      type: [float]
      desc:
    - name: cos_theta
      type: [float, n+1]
      desc:
    - name: phi
      type: [float, n+1]
      desc:
  outputs:
    - name: ps
      type: [float, n+1, 4]
      desc:
    - name: qs
      type: [float, n+1, 4]
      desc:

rambo_four_vectors_massive:
  inputs:
    - name: u
      type: [float, n]
      desc:
    - name: e_cm
      type: [float]
      desc:
    - name: cos_theta
      type: [float, n+1]
      desc:
    - name: phi
      type: [float, n+1]
      desc:
    - name: masses
      type: [float, n+2]
      desc:
  outputs:
    - name: ps
      type: [float, n+1, 4]
      desc:
    - name: qs
      type: [float, n+1, 4]
      desc:
    - name: e_cm_massless
      type: [float]
      desc:
    - name: det
      type: [float]
      desc:

---
title: Cuts

cut_pt:
  inputs:
    - name: p
      type: [float, n, 4]
      desc:
    - name: min_max
      type: [float, single, n-2, 2]
      desc:
  outputs:
    - name: w
      type: [float]
      desc:

cut_eta:
  inputs:
    - name: p
      type: [float, n, 4]
      desc:
    - name: min_max
      type: [float, single, n-2, 2]
      desc:
  outputs:
    - name: w
      type: [float]
      desc:

cut_dr:
  inputs:
    - name: p
      type: [float, n, 4]
      desc:
    - name: indices
      type: [int, single, m, 2]
      desc:
    - name: min_max
      type: [float, single, m, 2]
      desc:
  outputs:
    - name: w
      type: [float]
      desc:

cut_m_inv:
  inputs:
    - name: p
      type: [float, n, 4]
      desc:
    - name: indices
      type: [int, single, m, k]
      desc:
    - name: min_max
      type: [float, single, m, 2]
      desc:
  outputs:
    - name: w
      type: [float]
      desc:

cut_sqrt_s:
  inputs:
    - name: p
      type: [float, n, 4]
      desc:
    - name: min_max
      type: [float, single, 2]
      desc:
  outputs:
    - name: w
      type: [float]
      desc:

---
title: Chili

chili_forward:
  inputs:
    - name: r
      type: [float, 3n-2]
      desc:
    - name: e_cm
      type: [float]
      desc:
    - name: m_out
      type: [float, n]
      desc:
    - name: pt_min
      type: [float, n]
      desc:
    - name: y_max
      type: [float, n]
      desc:
  outputs:
    - name: p_ext
      type: [float, n+2]
      desc:
    - name: x1
      type: [float]
      desc:
    - name: x2
      type: [float]
      desc:
    - name: det
      type: [float]
      desc:

---
title: Interface to ME and PDF

matrix_element:
  inputs:
    - name: momenta
      type: [float, n, 4]
      desc:
    - name: amp2_remap
      type: [int, single, m]
      desc:
    - name: index
      type: [int, single]
      desc:
    - name: channel_count
      type: [size, c]
      desc:
  outputs:
    - name: matrix_element
      type: [float]
      desc:
    - name: channel_weights
      type: [float, c]
      desc:
  custom_op: True

pdf:
  inputs:
    - name: x
      type: [float]
      desc:
    - name: q2
      type: [float]
      desc:
    - name: pid
      type: [int]
      desc:
  outputs:
    - name: pdf
      type: [float]
      desc:
  custom_op: True

---
title: Normalizing flows and MLPs

matmul:
  inputs:
    - name: x
      type: [float, n]
      desc:
      backward_arg: True
    - name: weight
      type: [float, single, m, n]
      desc:
      backward_arg: True
    - name: bias
      type: [float, single, m]
      desc:
  outputs:
    - name: y
      type: [float, m]
      desc:
  custom_op: True
  #differentiable: True

leaky_relu:
  inputs:
    - name: in
      type: [float, ...]
      desc:
      backward_arg: True
  outputs:
    - name: out
      type: [float, ...]
      desc:
  dims: 2
  differentiable: True

rqs_activation:
  inputs:
    - name: input
      desc:
    - name: bin_count
      desc:
  outputs:
    - name: widths
      desc:
      backward_arg: True
    - name: heights
      desc:
      backward_arg: True
    - name: derivatives
      desc:
  class: RqsActivationInstruction
  #differentiable: True

rqs_find_bin:
  inputs:
    - name: input
      type: [float, n]
      desc:
    - name: in_sizes
      type: [float, n, b]
      desc:
    - name: out_sizes
      type: [float, n, b]
      desc:
    - name: derivatives
      type: [float, n, b+1]
      desc:
  outputs:
    - name: condition
      type: [float, n, 6]
      desc:
  #differentiable: True

rqs_forward:
  inputs:
    - name: input
      type: [float, n]
      desc:
      backward_arg: True
    - name: condition
      type: [float, n, 6]
      desc:
      backward_arg: True
  outputs:
    - name: output
      type: [float, n]
      desc:
    - name: det
      type: [float, n]
      desc:
  #differentiable: True

rqs_inverse:
  inputs:
    - name: input
      type: [float, n]
      desc:
      backward_arg: True
    - name: condition
      type: [float, n, 6]
      desc:
      backward_arg: True
  outputs:
    - name: output
      type: [float, n]
      desc:
    - name: det
      type: [float, n]
      desc:
  #differentiable: True

softmax:
  inputs:
    - name: input
      type: [float, n]
      desc:
  outputs:
    - name: output
      type: [float, n]
      desc:
      backward_arg: True
  differentiable: True

softmax_prior:
  inputs:
    - name: input
      type: [float, n]
      desc:
    - name: prior
      type: [float, n]
      desc:
      no_grad: True
  outputs:
    - name: output
      type: [float, n]
      desc:
      backward_arg: True
  differentiable: True

---
title: Discrete sampling

sample_discrete:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: option_count
      type: [int, single]
      desc:
  outputs:
    - name: output
      type: [int]
      desc:
    - name: det
      type: [float]
      desc:

sample_discrete_probs:
  inputs:
    - name: r
      type: [float]
      desc:
    - name: probs
      type: [float, n]
      desc:
  outputs:
    - name: output
      type: [int]
      desc:
    - name: det
      type: [float]
      desc:

gather:
  inputs:
    - name: index
      type: [int]
      desc:
    - name: choices
      type: [float, n]
      desc:
  outputs:
    - name: output
      type: [float]
      desc:

gather_int:
  inputs:
    - name: index
      type: [int]
      desc:
    - name: choices
      type: [int, n]
      desc:
  outputs:
    - name: output
      type: [int]
      desc:

one_hot:
  inputs:
    - name: index
      type: [int]
      desc:
    - name: option_count
      type: [size, n]
      desc:
  outputs:
    - name: output
      type: [float, n]
      desc:

---
title: VEGAS

vegas_forward:
  inputs:
    - name: input
      type: [float, n]
      desc:
    - name: grid
      type: [float, single, n, b]
      desc:
  outputs:
    - name: output
      type: [float, n]
      desc:
    - name: det
      type: [float]
      desc:

vegas_inverse:
  inputs:
    - name: input
      type: [float, n]
      desc:
    - name: grid
      type: [float, single, n, b]
      desc:
  outputs:
    - name: output
      type: [float, n]
      desc:
    - name: det
      type: [float]
      desc:

