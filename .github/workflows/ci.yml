name: Build

on: [push, pull_request]

jobs:
  build_wheels_linux:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v5

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.2.1
        env:
          CIBW_BUILD: cp311-manylinux_x86_64
          CIBW_BEFORE_ALL: >
            yum clean all &&
            yum -y install openblas-devel yum-utils &&
            yum-config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo &&
            yum -y install cuda-nvcc-12-8 cuda-cudart-devel-12-8 cuda-thrust-12-8 libcublas-devel-12-8 libcurand-devel-12-8
          CIBW_REPAIR_WHEEL_COMMAND: >
            auditwheel repair
            --exclude libmadevent.so
            --exclude 'libcublas.so.*'
            --exclude 'libcurand.so.*'
            --exclude 'libcublasLt.so.*'
            --exclude 'libcudart.so.*'
            -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT: PATH=$PATH:/usr/local/cuda/bin
          CIBW_TEST_REQUIRES: pytest numpy torch
          CIBW_TEST_COMMAND: pytest {project}/tests

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  build_wheels_macos:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-14]

    steps:
      - uses: actions/checkout@v5

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.2.1
        env:
          MACOSX_DEPLOYMENT_TARGET: 14.5
          CIBW_REPAIR_WHEEL_COMMAND: >
            delocate-wheel 
            --ignore-missing-dependencies
            --require-archs {delocate_archs} -w {dest_dir} -v {wheel}
          CIBW_TEST_REQUIRES: pytest numpy torch
          CIBW_TEST_COMMAND: pytest {project}/tests

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl
